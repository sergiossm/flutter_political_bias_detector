import 'dart:convert';

import 'package:flutter/foundation.dart';
import 'package:flutter_political_bias_detector/extensions.dart';
import 'package:rxdart/subjects.dart';
import 'package:http/http.dart' as http;

class HomeBloc {
  Stream<ButtonState> get buttonState => _buttonStateController.stream;
  Stream<Result> get result => _resultController.stream;

  final _buttonStateController = BehaviorSubject<ButtonState>();
  final _resultController = PublishSubject<Result>();

  void predict(String text) async {
    _buttonStateController.add(ButtonState.loading);

    final response = await http.post(
      Uri.parse('https://tfg-ssm.herokuapp.com/predict'),
      headers: <String, String>{
        'Content-Type': 'application/json; charset=UTF-8',
      },
      body: jsonEncode(<String, String>{
        'input_text': text,
      }),
    );

    if (response.statusCode == 200) _resultController.add(_processResult(Result.fromJson(jsonDecode(response.body))));

    // _resultController.add(Result.fromJson(jsonDecode(_jsonResult)));

    _buttonStateController.add(ButtonState.iddle);
  }

  Result _processResult(Result result) {
    final List<String> tokens = result.text.split(' ');
    final List<double> attention = List.from(result.attention);

    // Eliminar xxbos
    tokens.removeAt(0);
    attention.removeAt(0);

    final List<int> xxmajIndices = [], xxupIndices = [];
    for (var i = 0; i < tokens.length; i++) {
      switch (tokens[i]) {
        case 'xxunk':
          tokens[i] = '_';
          break;
        case 'xxmaj':
          if (tokens[i + 1] != 'xxunk') {
            tokens[i + 1] = tokens[i + 1].capitalize();
          }
          xxmajIndices.add(i);
          break;
        case 'xxup':
          tokens[i + 1] = tokens[i + 1].toUpperCase();
          xxupIndices.add(i);
          break;
        default:
      }
    }

    for (var i = 0; i < xxmajIndices.length; i++) {
      var index = xxmajIndices[i] - i;

      tokens.removeAt(index);
      attention.removeAt(index);
    }
    for (var i = 0; i < xxupIndices.length; i++) {
      var index = xxupIndices[i] - i - xxmajIndices.length;

      tokens.removeAt(index);
      attention.removeAt(index);
    }

    return Result(attention: attention, text: tokens.join(' '), predictions: result.predictions);
  }

  void dispose() {
    _buttonStateController.close();
  }
}

class Result {
  final List<double> attention;
  final String text;
  final Map<String, double> predictions;

  const Result({
    @required this.attention,
    @required this.text,
    @required this.predictions,
  });

  factory Result.fromJson(Map<String, dynamic> json) => Result(
        attention: List.from(json['attention']),
        text: json['text'],
        predictions: Map.from(json['preds']),
      );
}

enum ButtonState { iddle, loading }

String _jsonResult =
    "{\"attention\":[0.027470925822854042,0.02175699919462204,0.026099953800439835,0.0372171625494957,0.0666409507393837,0.027952980250120163,0.08712997287511826,0.0402909554541111,0.11066284030675888,0.14813470840454102,0.014633547514677048,0.027736075222492218,0.07088703662157059,0.09792356938123703,0.011576280929148197,0.025454184040427208,0.04142703488469124,0.0023847674019634724,0.004451041109859943,0.03500250354409218,0.10141860693693161,0.025023775175213814,0.035187527537345886,0.10490848124027252,0.03215610980987549,0.03931889683008194,0.02350596897304058,0.011586668901145458,0.020261747762560844,0.05043623968958855,0.0021302553359419107,0.0033412943594157696,0.0161296334117651,0.03340219333767891,0.04713882505893707,0.1282266527414322,0.04743041470646858,0.13700416684150696,0.06873012334108353,0.16700991988182068,0.016304077580571175,0.03976871073246002,0.004189455881714821,0.012617453932762146,0.03273177891969681,0.015736451372504234,0.012488025240600109,0.02765176072716713,0.003292778739705682,0.005851332098245621,0.09256396442651749,0.26558399200439453,0.0037481538020074368,0.029948396608233452,0.06778902560472488,0.012732204049825668,0.021669207140803337,0.05712505057454109,0.11462349444627762,0.009189904667437077,0.038421545177698135,0.07406003028154373,0.0044670808129012585,0.009679863229393959,0.007513692136853933,0.004835283383727074,0.03459068760275841,0.08358096331357956,0.004370727576315403,0.014397958293557167,0.036291297525167465,0.050375089049339294,0.005248783156275749,0.021444300189614296,0.061257921159267426,0.07045859843492508,0.006774638779461384,0.04566289484500885,0.11616391688585281,0.025797929614782333,0.008539963513612747,0.014890547841787338,0.006171225570142269,0.018731148913502693,0.046491336077451706,0.016429878771305084,0.0061956970021128654,0.016094140708446503,0.025215718895196915,0.020566541701555252,0.046513140201568604,0.008301418274641037,0.016412781551480293,0.01590852253139019,0.03631645441055298,0.02758985385298729,0.06710844486951828,0.012292600236833096,0.022871559485793114,0.003534831805154681,0.007089805323630571,0.015285150147974491,0.033166948705911636,0.00820345152169466,0.011210644617676735,0.017047708854079247,0.04252901300787926,0.09684614837169647,0.036932360380887985,0.061653587967157364,0.006833727937191725,0.03137873858213425,0.10349796712398529,0.5181253552436829,1.0,0.011436812579631805,0.08743204921483994,0.24253295361995697,0.021542247384786606,0.07288453727960587,0.18085424602031708,0.00890965387225151,0.029890451580286026,0.09451819211244583,0.002289130352437496,0.0033089665230363607,0.008333193138241768,0.016095152124762535,0.03639267385005951,0.015332575887441635,0.03488145023584366,0.015734290704131126,0.004810691345483065,0.014789114706218243,0.04933003708720207,0.13543887436389923,0.0032055291812866926,0.006068394985049963,0.00998225063085556,0.019586198031902313,0.004850281402468681,0.023621048778295517,0.020505204796791077,0.003478445578366518,0.016890497878193855,0.046182096004486084,0.010020577348768711,0.016500350087881088,0.004339297767728567,0.01432584598660469,0.032985299825668335,0.007232104428112507,0.013228820636868477,0.027634546160697937,0.05774736776947975,0.0024065400939434767,0.0352226197719574,0.1009475514292717,0.011059734970331192,0.029032422229647636,0.002234674757346511,0.004321920685470104,0.0026034265756607056,0.006093798205256462,0.01218943390995264,0.0084539158269763,0.023092661052942276,0.061270058155059814,0.07588684558868408,0.01885162852704525,0.04712149500846863,0.009547930210828781,0.0014143253210932016,0.0028207646682858467,0.006923008244484663,0.01748811826109886,0.020778395235538483,0.014995616860687733,0.033646028488874435,0.025050349533557892,0.05039452388882637,0.005508588161319494,0.02291705831885338,0.051716942340135574,0.01590237021446228,0.013407657854259014,0.013881867751479149,0.0308946892619133,0.011858903802931309,0.07607436180114746,0.2213411033153534,0.003275252180173993,0.00882800668478012,0.02204206772148609,0.002731930697336793,0.0025850425008684397,0.022102922201156616,0.05428101122379303,0.004003352485597134,0.01672700047492981,0.033836934715509415,0.008400513790547848,0.012736537493765354,0.0023267364595085382,0.010253597982227802,0.031015312299132347,0.02930579148232937,0.04956905171275139,0.005873052403330803,0.01052827574312687,0.009657490067183971,0.004723875783383846,0.004996772855520248,0.01680912636220455,0.044272903352975845,0.018867895007133484,0.010508655570447445,0.0412229560315609,0.09091970324516296,0.0907018631696701,0.03863881528377533,0.07346159219741821,0.04173784703016281,0.00643968116492033,0.15631164610385895,0.5004758238792419,0.0017265714704990387,0.0020451992750167847,0.013302383944392204,0.031369809061288834,0.007977726869285107,0.02196580544114113,0.043790701776742935,0.011322394013404846,0.018241386860609055,0.03447852283716202,0.013881459832191467,0.015836812555789948,0.037652816623449326,0.013110913336277008,0.013091986998915672,0.011155340820550919,0.024179862812161446,0.04453374445438385,0.13252529501914978,0.04969731345772743,0.11392883211374283,0.05669334530830383,0.011336839757859707,0.007493586279451847,0.015554696321487427,0.010110057890415192,0.04967016354203224,0.12987735867500305,0.011088789440691471,0.026034105569124222,0.015148616395890713,0.03807101771235466,0.00920664519071579,0.024087803438305855,0.0022998114582151175,0.00579000823199749,0.014999127015471458,0.012567749246954918,0.03891368210315704,0.048058684915304184,0.026100700721144676,0.04310256615281105,0.13082510232925415,0.006510482169687748,0.004386471584439278,0.01118385884910822,0.003810497000813484,0.01566206105053425,0.038392987102270126,0.0036655862350016832,0.01863124594092369,0.05609207600355148,0.012035971507430077,0.024935593828558922,0.012250994332134724,0.02567867934703827,0.02020120806992054,0.05230620875954628,0.011156625114381313,0.08071611076593399,0.2341572493314743,0.0025064516812562943,0.001584811368957162,0.004102940205484629,0.0067731584422290325,0.00495440186932683,0.015475351363420486,0.035685945302248,0.02254236303269863,0.1297377347946167,0.3220340609550476,0.02273816056549549,0.0009490850497968495,0.002076555974781513,0.004431135021150112,0.016365325078368187,0.04625152796506882,0.09427905827760696,0.0020200677681714296,0.005662037990987301,0.008952713571488857,0.019277483224868774,0.048137545585632324,0.0009988220408558846,0.0019468213431537151,0.004093751311302185,0.006253078114241362,0.022937865927815437,0.027679555118083954,0.059350576251745224,0.020328547805547714,0.03358518332242966,0.02177637629210949,0.08324258774518967,0.21136526763439178,0.0021061254665255547,0.005477972328662872,0.013695446774363518,0.0521530844271183,0.05239037051796913,0.015401280485093594,0.04275936260819435,0.06818793714046478,0.1717280149459839,0.011108395643532276,0.030376700684428215,0.002449573250487447,0.014049401506781578,0.03741443529725075,0.0029987783636897802,0.002028790768235922,0.0042018224485218525,0.03162192553281784,0.08925331383943558,0.018081430345773697,0.00277106580324471,0.0037697700317949057,0.020340407267212868,0.04691693186759949,0.0056875827722251415,0.014887054450809956,0.0380881167948246,0.008075009100139141,0.021097417920827866,0.042922988533973694,0.054543834179639816,0.14879989624023438,0.002420419594272971,0.02077987976372242,0.05131293088197708,0.005032187793403864,0.017296576872467995,0.03562329709529877,0.06707095354795456,0.048111625015735626,0.014967420138418674,0.0237061008810997,0.06696044653654099,0.022056033834815025,0.020333601161837578,0.05975279584527016,0.0315592885017395,0.10595089942216873,0.1687336266040802,0.004490524064749479,0.014618847519159317,0.030650539323687553,0.007991422899067402,0.01722840778529644,0.01558766420930624,0.0020528489258140326,0.0035813467111438513,0.009706879034638405,0.00789861660450697,0.030434947460889816,0.06643655151128769,0.010763402096927166,0.0206049382686615,0.027262600138783455,0.07462207973003387,0.1329440027475357,0.2013276368379593,0.0334748849272728,0.08877891302108765,0.0021754771005362272,0.0027286990080028772,0.00571406027302146,0.01282544806599617,0.017677631229162216,0.03888225555419922,0.09213540703058243,0.05171724408864975,0.11445996165275574,0.0016840057214722037,0.008718437515199184,0.021941659972071648,0.0006211032741703093,0.0014194193063303828,0.0042232945561409,0.01590726152062416,0.036006029695272446,0.021009942516684532,0.06838008761405945,0.01770583726465702,0.004095747601240873,0.009936879388988018,0.0038743524346500635,0.016934499144554138,0.03828117623925209,0.030258864164352417,0.004998666699975729,0.0072366888634860516,0.011871215887367725,0.014064600691199303,0.015022274106740952,0.02839807979762554,0.08353855460882187,0.010511270724236965,0.014450759626924992,0.05096840485930443,0.14615704119205475,0.04603444039821625,0.13405655324459076,0.06145363673567772,0.1619160771369934,0.1427425593137741,0.003665460739284754,0.002726700622588396,0.008084922097623348,0.008729728870093822,0.014356261119246483,0.052059322595596313,0.1498493254184723,0.022131823003292084,0.06330733746290207,0.1530044823884964,0.010072634555399418,0.05588899925351143,0.1475737988948822,0.0009278116049245,0.001579666743054986,0.0042613809928298,0.00891342293471098,0.004853833932429552,0.025413798168301582,0.07006384432315826,0.004909541457891464,0.021503590047359467,0.04519191011786461,0.02142694965004921,0.026656480506062508,0.05633217841386795,0.02114952728152275,0.0006262545357458293,0.000696190632879734,0.0012672721641138196,0.0011417983332648873,0.02012735977768898,0.05662280693650246,0.02020796202123165,0.002740634372457862,0.008457877673208714,0.02524638921022415,0.05535874143242836,0.002004345180466771,0.006980688311159611,0.012859182432293892,0.011826574802398682,0.02628578618168831,0.008157134056091309,0.015410618856549263,0.001021190662868321,0.008979090489447117,0.0268136914819479,0.0006295745261013508,0.0008928605238907039,0.011452797800302505,0.0331546850502491,0.052243154495954514,0.018387438729405403,0.05179750546813011,0.018875382840633392,0.00896892324090004,0.01824217475950718,0.003319739131256938,0.0022752503864467144,0.011873377487063408,0.036415569484233856,0.002583413850516081,0.009501456283032894,0.023127779364585876,0.002897711470723152,0.01705317012965679,0.03968198597431183,0.013666375540196896,0.013540036976337433,0.02287895232439041,0.005069985520094633,0.023200547322630882,0.05516096204519272,0.017016245052218437,0.04348240792751312,0.007036433555185795,0.024111365899443626,0.06992340087890625,0.13308754563331604,0.02455511875450611,0.04208511486649513,0.011359870433807373,0.024411641061306,0.016056973487138748,0.04435063153505325,0.0047108870930969715,0.0368928425014019,0.12086892127990723,0.00878926645964384,0.021272890269756317,0.05624128878116608,0.16217558085918427,0.19234178960323334,0.06171632185578346,0.1540348082780838,0.19622458517551422,0.4766291379928589,0.01054698508232832],\"preds\":{\"GCUP-EC-GC\":4.42617130279541,\"GCs\":0.025706686079502106,\"GP\":0.12669792771339417,\"GS\":0.9633004665374756,\"GVOX\":94.4581298828125},\"text\":\"xxbos xxmaj se ha comentado la profusi\u00f3n de banderas andaluzas en los \u00faltimos m\u00edtines del xxup pp . xxmaj hay documentos gr\u00e1ficos que certifican el mar xxunk de xxmaj feij\u00f3o . xxmaj pero gracias al testimonio del periodista xxmaj alfonso xxmaj xxunk , que estaba all\u00ed , sabemos que en el mitin en xxmaj c\u00e1diz s\u00ed hubo una bandera de xxmaj espa\u00f1a , una , en el collar de un xxunk presente : el perro patriota , cuya estupefacci\u00f3n territorial nos llega en la foto . xxmaj ese xxunk de incomprensi\u00f3n que est\u00e1 a punto de dar el xxunk \u00bf no nos representa ? \u00bf no lo dar\u00edamos los dem\u00e1s ? xxmaj hay una derecha que la bandera se la pone a la mascota . xxmaj se la ponen el primer d\u00eda y ah\u00ed la dejan , como si fuera un xxunk . xxmaj los giros del xxunk , como ahora , les pueden llevar por xxmaj blas xxmaj infante , pero no les importa mientras el perro lleve la nacional . xxmaj es como si hubiera un pacto no escrito , una cl\u00e1usula del 78 que tolera la bandera circunscrita a xxmaj madrid , en xxmaj col\u00f3n , por ejemplo , toda la que quieran , infinita si quieren , y en los xxunk . xxmaj ah\u00ed pueden llevarla sin problema alguno : el patriotismo es para los xxunk , los xxunk y los xxunk . xxmaj nadie les va a ir a llamar xxunk fachas xxunk . xxmaj tenemos as\u00ed un patriotismo de xxunk , tolerable en xxunk , que llevan la bandera moviendo alegremente el rabo . xxmaj aunque se les censure con la mirada , nadie la va a tomar con los animales . \u00bf xxmaj por qu\u00e9 los perros pueden ser abiertamente xxunk ? \u00bf xxmaj qu\u00e9 libertad disfrutan que no tenemos los humanos ? \u00bf xxmaj por qu\u00e9 se tolera en ellos la xxunk patri\u00f3tica ? xxmaj la mascota patri\u00f3tica , subalterna , alivia la conciencia de sus due\u00f1os , que no se preocupan mucho de lo que pase en xxmaj gerona mientras su perro parezca patrocinado por un estanco . xxmaj en cierto modo , son utilizados tristemente para representar unas ideas humanas que el due\u00f1o no siempre defiende . xxmaj se les hace abanderados , pero \u00bf puede ser espa\u00f1ol un perro ? \u00bf xxmaj no ser\u00e1 xxmaj galicia m\u00e1s espa\u00f1ola que los xxunk ? \u00bf xxmaj hay acaso una espa\u00f1olidad xxunk ? \u00a1 xxmaj sus due\u00f1os afirman que s\u00ed ! y con su collar van diciendo : xxunk este perro es espa\u00f1ol xxunk . xxmaj es como si el espa\u00f1olismo se fuera restringiendo a otras especies . . . -yo no soy facha . xxmaj otra cosa es mi perro . . . xxmaj la espa\u00f1olidad xxunk es una forma xxunk que ha adoptado el 78 a medida que se desarrolla . xxmaj el perro abanderado ser\u00e1 seguido despu\u00e9s , quiz\u00e1s , por los gatos , los xxunk , las tortugas ... a medida que xxmaj espa\u00f1a se xxunk , el xxup pp ir\u00e1 xxunk xxmaj madrid y xxunk a las mascotas , y el xxunk parecer\u00e1 xxmaj casa xxmaj pepe .\"}";
